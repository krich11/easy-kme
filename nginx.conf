# Easy-KME Site Configuration
# Place this file in /etc/nginx/sites-available/easy-kme
# Then create symlink: sudo ln -s /etc/nginx/sites-available/easy-kme /etc/nginx/sites-enabled/

# HTTPS server with mTLS for Easy-KME
server {
    listen 8443 ssl;
    server_name localhost;

    # SSL configuration
    ssl_certificate /home/krich/src/easy-kme/certs/kme/kme.crt;
    ssl_certificate_key /home/krich/src/easy-kme/certs/kme/kme.key;
    
    # Client certificate verification
    ssl_client_certificate /home/krich/src/easy-kme/certs/ca/ca.crt;
    ssl_verify_client on;
    ssl_verify_depth 10;

    # SSL settings

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # Proxy settings
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass client certificate information - FIXED
        proxy_set_header X-Client-Verified $ssl_client_verify;
        proxy_set_header X-Client-DN $ssl_client_s_dn;
        proxy_set_header X-Client-Subject $ssl_client_s_dn;
        proxy_set_header X-Client-Issuer $ssl_client_i_dn;
        
        # Additional SSL info for debugging
        proxy_set_header X-SSL-Protocol $ssl_protocol;
        proxy_set_header X-SSL-Cipher $ssl_cipher;
        
        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass client certificate information - FIXED
        proxy_set_header X-Client-Verified $ssl_client_verify;
        proxy_set_header X-Client-DN $ssl_client_s_dn;
        proxy_set_header X-Client-Subject $ssl_client_s_dn;
        proxy_set_header X-Client-Issuer $ssl_client_i_dn;
        
        # Additional SSL info for debugging
        proxy_set_header X-SSL-Protocol $ssl_protocol;
        proxy_set_header X-SSL-Cipher $ssl_cipher;
    }
} 
